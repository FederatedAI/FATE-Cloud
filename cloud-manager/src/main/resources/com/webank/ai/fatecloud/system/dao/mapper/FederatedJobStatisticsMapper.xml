<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.webank.ai.fatecloud.system.dao.mapper.FederatedJobStatisticsMapper">

    <resultMap id="jobStatisticsMap" type="com.webank.ai.fatecloud.system.pojo.dto.JobStatisticsOfSiteDimension">

        <result property="siteGuestName" column="siteGuestName"></result>

        <collection property="institutionsWithHostSites"
                    ofType="com.webank.ai.fatecloud.system.pojo.dto.InstitutionsWithHostSite">

            <result property="institutions" column="institutions"></result>

            <collection property="jobStatisticsList" ofType="com.webank.ai.fatecloud.system.pojo.dto.JobStatistics">
                <result property="siteHostName" column="siteHostName"></result>
                <result property="jobSuccessCount" column="job_success_count"></result>
                <result property="jobFailedCount" column="job_failed_count"></result>
                <result property="jobRunningCount" column="job_running_count"></result>
            </collection>
        </collection>

    </resultMap>


    <select id="getJobStatisticsOfSiteDimension"
            parameterType="com.webank.ai.fatecloud.system.pojo.qo.JobOfSiteDimensionQo" resultMap="jobStatisticsMap">
        SELECT sm.site_name siteHostName,sm2.site_name
        siteGuestName,js.job_success_count,js.job_failed_count,js.job_running_count,sm.institutions
        FROM t_job_statistics js,t_federated_site_manager sm,t_federated_site_manager sm2
        where js.site_guest_id in (select id from t_federated_site_manager where institutions =#{institutions} and
        status = 2)
        and js.job_finish_date between #{dateToday,jdbcType=DATE} and #{dateToday,jdbcType=DATE}
        and sm.id=js.site_host_id
        and sm2.id=js.site_guest_id
    </select>

    <select id="getJobStatisticsODimension"
            parameterType="com.webank.ai.fatecloud.system.pojo.qo.JobOfSiteDimensionQo"
            resultType="com.webank.ai.fatecloud.system.pojo.dto.JobStatisticOfInstitutionsDimensionDto">
        SELECT sm2.institutions,sum(js.job_success_count) successJobCountForInstitutions,sum(js.job_failed_count) failedJobCountForInstitutions, sum(js.job_running_count) runningJobCountForInstitutions
        FROM t_job_statistics js,t_federated_site_manager sm,t_federated_site_manager sm2
        where js.site_guest_id =sm.id
        and js.site_host_id=sm2.id
        and js.job_finish_date=#{dateToday,jdbcType=DATE}
        and js.site_guest_id in (select id from t_federated_site_manager where institutions =#{institutions} and status = 2)
        group by sm2.institutions
    </select>

    <select id="getJobStatisticsSummaryTodayInstitutionsAll"
            parameterType="com.webank.ai.fatecloud.system.pojo.qo.JobStatisticsSummaryTodayQo"
            resultType="com.webank.ai.fatecloud.system.pojo.dto.JobStatisticsSummaryTodayInstitutionsAllDto">
        SELECT count(1) institutionsCount,sum(tmp.job_failed_count) failedJobCount,sum(tmp.job_success_count) successJobCount ,sum(tmp.job_running_count) runningJobCount
        from
        (select sm.institutions,sum(js.job_failed_count) job_failed_count,sum(js.job_success_count) job_success_count,sum(js.job_running_count) job_running_count
        FROM t_job_statistics js,t_federated_site_manager sm
        where js.site_guest_id =sm.id
        and js.job_finish_date=#{dateToday,jdbcType=DATE}
        group by sm.institutions) tmp
    </select>

    <select id="getJobStatisticsSummaryTodayInstitutionsEachCount"
            parameterType="com.webank.ai.fatecloud.system.pojo.qo.JobStatisticsSummaryTodayQo"
            resultType="long">
        select count(1) from
        (select  sm.institutions
        FROM t_job_statistics js,t_federated_site_manager sm
        where js.site_guest_id =sm.id
        and js.job_finish_date=#{dateToday,jdbcType=DATE}
        group by sm.institutions) tmp
    </select>

    <select id="getJobStatisticsSummaryTodayInstitutionsEach"
            resultType="com.webank.ai.fatecloud.system.pojo.dto.JobStatisticsSummaryTodayInstitutionsEachDto">
        select institutions, sum(js.job_failed_count) failedJobCount,sum(js.job_success_count) successJobCount,sum(js.job_running_count) runningJobCount
        FROM t_job_statistics js,t_federated_site_manager sm
        where js.site_guest_id =sm.id
        and js.job_finish_date=#{jobStatisticsSummaryTodayQo.dateToday,jdbcType=DATE}
        group by sm.institutions order by sm.institutions asc limit #{startIndex}, #{jobStatisticsSummaryTodayQo.pageSize}
    </select>

    <select id="getJobStatisticsSummaryTodaySiteAll"
            parameterType="com.webank.ai.fatecloud.system.pojo.qo.JobStatisticsSummaryTodaySiteAllQo"
            resultType="com.webank.ai.fatecloud.system.pojo.dto.JobStatisticsSummaryTodaySiteAllDto">
        SELECT count(1) siteCount,sum(tmp.job_failed_count) failedJobCount,sum(tmp.job_success_count) successJobCount ,sum(tmp.job_running_count) runningJobCount
        from
        ( select js.site_guest_id,js.job_failed_count,js.job_success_count
        FROM t_job_statistics js,t_federated_site_manager sm
        where js.site_guest_id =sm.id
        and js.job_finish_date=#{dateToday,jdbcType=DATE}
        and sm.institutions =#{institutions} ) tmp
    </select>

    <select id="getJobStatisticsSummaryTodaySiteEachCount"
            parameterType="com.webank.ai.fatecloud.system.pojo.qo.JobStatisticsSummaryTodaySiteAllQo"
            resultType="long">
        select count(1) from
        (select sm.site_name
        FROM t_job_statistics js,t_federated_site_manager sm
        where js.site_guest_id =sm.id
        and js.job_finish_date=#{dateToday,jdbcType=DATE}
        and sm.institutions =#{institutions}
        group by sm.site_name) tmp
    </select>

    <select id="getJobStatisticsSummaryTodaySiteEach"
            resultType="com.webank.ai.fatecloud.system.pojo.dto.JobStatisticsSummaryTodaySiteEachDto">
        select sm.site_name site,sm.party_id partyId, sum(js.job_failed_count) failedJobCount,sum(js.job_success_count) successJobCount,sum(js.job_running_count) runningJobCount
        FROM t_job_statistics js,t_federated_site_manager sm
        where js.site_guest_id =sm.id
        and js.job_finish_date=#{jobStatisticsSummaryTodaySiteAllQo.dateToday,jdbcType=DATE}
        and sm.institutions =#{jobStatisticsSummaryTodaySiteAllQo.institutions}
        group by sm.site_name order by sm.site_name asc limit #{startIndex}, #{jobStatisticsSummaryTodaySiteAllQo.pageSize}
    </select>


    <select id="getJobStatisticsOfSiteDimensionForPeriod"
            parameterType="com.webank.ai.fatecloud.system.pojo.qo.JobOfSiteDimensionPeriodQo" resultMap="jobStatisticsMap">
        SELECT sm.site_name siteHostName,sm2.site_name siteGuestName,count(js.job_success_count) job_success_count,count(js.job_failed_count) job_failed_count,count(js.job_running_count) job_running_count,sm.institutions
        FROM t_job_statistics js,t_federated_site_manager sm,t_federated_site_manager sm2
        where js.site_guest_id in (select id from t_federated_site_manager where institutions =#{institutions} and
        status = 2)
        and js.job_finish_date between #{beginDate,jdbcType=DATE} and #{endDate,jdbcType=DATE}
        and sm.id=js.site_host_id
        and sm2.id=js.site_guest_id
        group by sm.site_name,sm2.site_name,sm.institutions
    </select>

    <select id="getJobStatisticsODimensionForPeriod"
            parameterType="com.webank.ai.fatecloud.system.pojo.qo.JobOfSiteDimensionPeriodQo"
            resultType="com.webank.ai.fatecloud.system.pojo.dto.JobStatisticOfInstitutionsDimensionDto">
        SELECT sm2.institutions,sum(js.job_success_count) successJobCountForInstitutions,sum(js.job_failed_count) failedJobCountForInstitutions,,sum(js.job_running_count) runningJobCountForInstitutions
        FROM t_job_statistics js,t_federated_site_manager sm,t_federated_site_manager sm2
        where js.site_guest_id = sm.id
        and js.site_host_id=sm2.id
        and js.job_finish_date between #{beginDate,jdbcType=DATE}  and #{endDate,jdbcType=DATE}
        and js.site_guest_id in (select id from t_federated_site_manager where institutions =#{institutions} and status = 2)
        group by sm2.institutions
    </select>

    <select id="getJobStatisticsSummaryInstitutionsAllForPeriod"
            parameterType="com.webank.ai.fatecloud.system.pojo.qo.JobStatisticsSummaryForPeriodQo"
            resultType="com.webank.ai.fatecloud.system.pojo.dto.JobStatisticsSummaryTodayInstitutionsAllDto">
        SELECT count(1) institutionsCount,sum(tmp.job_failed_count) failedJobCount,sum(tmp.job_success_count) successJobCount,sum(tmp.job_running_count) runningJobCount
        from
        (select sm.institutions,sum(js.job_failed_count) job_failed_count,sum(js.job_success_count) job_success_count,sum(js.job_running_count) job_running_count
        FROM t_job_statistics js,t_federated_site_manager sm
        where js.site_guest_id = sm.id
        and js.job_finish_date between #{beginDate,jdbcType=DATE}  and #{endDate,jdbcType=DATE}
        group by sm.institutions) tmp
    </select>

    <select id="getJobStatisticsSummaryInstitutionsEachForPeriodCount"
            parameterType="com.webank.ai.fatecloud.system.pojo.qo.JobStatisticsSummaryForPeriodQo"
            resultType="long">
        select count(1) from
        (select sm.institutions
        FROM t_job_statistics js,t_federated_site_manager sm
        where js.site_guest_id =sm.id
        and js.job_finish_date between #{beginDate,jdbcType=DATE}  and #{endDate,jdbcType=DATE}
        group by sm.institutions) tmp
    </select>

    <select id="getJobStatisticsSummaryInstitutionsEachForPeriod"
            resultType="com.webank.ai.fatecloud.system.pojo.dto.JobStatisticsSummaryTodayInstitutionsEachDto">
        select sm.institutions, sum(js.job_failed_count) failedJobCount,sum(js.job_success_count) successJobCount,sum(js.job_running_count) runningJobCount
        FROM t_job_statistics js,t_federated_site_manager sm
        where js.site_guest_id =sm.id
        and js.job_finish_date between #{jobStatisticsSummaryForPeriodQo.beginDate,jdbcType=DATE}  and #{jobStatisticsSummaryForPeriodQo.endDate,jdbcType=DATE}
        group by sm.institutions order by sm.institutions asc limit #{startIndex}, #{jobStatisticsSummaryForPeriodQo.pageSize}
    </select>

    <select id="getJobStatisticsSummarySiteAllForPeriod"
            parameterType="com.webank.ai.fatecloud.system.pojo.qo.JobStatisticsSummarySiteAllForPeriodQo"
            resultType="com.webank.ai.fatecloud.system.pojo.dto.JobStatisticsSummaryTodaySiteAllDto">
        SELECT count(1) siteCount,sum(tmp.job_failed_count) failedJobCount,sum(tmp.job_success_count) successJobCount,sum(tmp.job_running_count) runningJobCount
        from
        ( select js.site_guest_id,js.job_failed_count,js.job_success_count,js.job_running_count
        FROM t_job_statistics js,t_federated_site_manager sm
        where js.site_guest_id =sm.id
        and js.job_finish_date between #{beginDate,jdbcType=DATE}  and #{endDate,jdbcType=DATE}
        and sm.institutions =#{institutions} ) tmp
    </select>

    <select id="getJobStatisticsSummarySiteEachForPeriodCount"
            parameterType="com.webank.ai.fatecloud.system.pojo.qo.JobStatisticsSummarySiteAllForPeriodQo"
            resultType="long">
        select count(1) from (select count(1)
        FROM t_job_statistics js,t_federated_site_manager sm
        where js.site_guest_id =sm.id
        and js.job_finish_date between #{beginDate,jdbcType=DATE}  and #{endDate,jdbcType=DATE}
        and sm.institutions =#{institutions}
        group by sm.site_name) tmp
    </select>

    <select id="getJobStatisticsSummarySiteEachForPeriod"
            resultType="com.webank.ai.fatecloud.system.pojo.dto.JobStatisticsSummaryTodaySiteEachDto">
        select sm.site_name site, sm.party_id partyId,sum(js.job_failed_count) failedJobCount,sum(js.job_success_count) successJobCount,sum(js.job_running_count) runningJobCount
        FROM t_job_statistics js,t_federated_site_manager sm
        where js.site_guest_id =sm.id
        and js.job_finish_date between #{jobStatisticsSummarySiteAllForPeriodQo.beginDate,jdbcType=DATE}  and #{jobStatisticsSummarySiteAllForPeriodQo.endDate,jdbcType=DATE}
        and sm.institutions =#{jobStatisticsSummarySiteAllForPeriodQo.institutions}
        group by sm.site_name order by sm.site_name asc limit #{startIndex}, #{jobStatisticsSummarySiteAllForPeriodQo.pageSize}
    </select>

</mapper>
